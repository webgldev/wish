let e,t,n,o,i,a;!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();let s,r,l,c=[],d=new THREE.Vector3,u=new THREE.Vector3,m=null,p=null;document.addEventListener("DOMContentLoaded",(function(){if(window.hasDOMContentLoaded)return;window.hasDOMContentLoaded=!0;const y=document.getElementById("passwordInput"),E=document.getElementById("closePlanetForm"),w=document.getElementById("submitPassword"),h=document.getElementById("wishModal"),I=document.getElementById("closeWishModal"),f=document.getElementById("wishName"),g=document.getElementById("wishText"),v=document.getElementById("modifyWishBtn"),T=document.getElementById("editWishDiv"),M=document.getElementById("editNameInput"),B=document.getElementById("editWishInput"),R=document.getElementById("editPasswordInput"),b=document.getElementById("saveWishBtn"),P=document.getElementById("cancelWishBtn"),x=document.getElementById("planetFormModal"),C=document.getElementById("passwordInput"),S=document.getElementById("closePasswordInputModal"),k=document.getElementById("resetView"),D=document.getElementById("container"),H=document.getElementById("createPlanetBtn"),L="https://tlojtipiijabtnakekwp.supabase.co";function O(e,t){const n=document.createElement("span");n.className="password-error-message",n.style.color="red",n.style.fontSize="0.9em",n.style.marginTop="5px",n.textContent=t,e.parentNode.insertBefore(n,e.nextSibling)}async function j(){if(!p)return;const e=M.value.trim(),t=B.value.trim(),n=R.value.trim();if(""===e||""===t||""===n)return;if(!/^\d+$/.test(n))return;if(!c.some((t=>t.userData.name===e&&t!==m))&&(p.userData.name=e,p.userData.wish=t,p.userData.pageId))try{if(await async function(e,t,n){const o={Name:{title:[{text:{content:t}}]},Wish:{rich_text:[{text:{content:n}}]}};try{const t=await fetch(`${L}/functions/v1/moon/updateNotion/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRsb2p0aXBpaWphYnRuYWtla3dwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjYzNTU1OTEsImV4cCI6MjA0MTkzMTU5MX0.Oy4oW0oCnSSV2aIFPJ-NO8cLQjtrqEcrwu1F2nJj-TU"},body:JSON.stringify({properties:o})});if(t.ok);else{await t.text()}}catch(i){}}(p.userData.pageId,e,t),f.textContent=e,g.textContent=t,p.userData.textSprite){p.remove(p.userData.textSprite);const t=W(e);t.position.set(0,.8,0),p.add(t),p.userData.textSprite=t}J()}catch(o){}}function J(){f.style.display="block",g.style.display="block",v.style.display="inline",I.style.display="inline",T.style.display="none"}window.addEventListener("load",(async()=>{!async function(t){try{const n=await fetch(`${L}/functions/v1/moon/getNotionData`,{method:"GET",headers:{Authorization:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRsb2p0aXBpaWphYnRuYWtla3dwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjYzNTU1OTEsImV4cCI6MjA0MTkzMTU5MX0.Oy4oW0oCnSSV2aIFPJ-NO8cLQjtrqEcrwu1F2nJj-TU"}});if(n.ok){(await n.json()).forEach((n=>{var o,i,a,s,r,d;const u=null==(o=n.properties.Name)?void 0:o.title,m=null==(i=n.properties.Wish)?void 0:i.rich_text,p=u&&(null==(s=null==(a=u[0])?void 0:a.text)?void 0:s.content)||"Unknown",y=m&&(null==(d=null==(r=m[0])?void 0:r.text)?void 0:d.content)||"No wish",E=n.id;t(p,y,null,e,c,l,!1,E)}))}}catch(n){}}(z)})),window.addEventListener("click",(function(o){o.preventDefault();const i=n.domElement.getBoundingClientRect();r.x=(o.clientX-i.left)/i.width*2-1,r.y=-(o.clientY-i.top)/i.height*2+1,s.setFromCamera(r,t);const a=e.children.filter((e=>e.userData.isInteractable)),l=s.intersectObjects(a,!0);if(l.length>0&&l[0].object){let e=l[0].object;if("Blackwalnut_Autumn01_Blackwalnut_Autumn01_Mat_0"===e.userData.name||"Blackwalnut_Autumn01_Blackwalnut_Bark_Mat_0"===e.userData.name)return void(x.style.display="grid");for(;e;){if(e.userData&&e.userData.name){m=e,p=m;const t=document.getElementById("planetName");return t&&m.userData.name&&(t.textContent=`행성 이름: ${m.userData.name}`),void(y.style.display="grid")}e=e.parent}m=null,y.style.display="none",x.style.display="none"}else m=null,y.style.display="none",x.style.display="none"}),!1),I.addEventListener("click",(e=>{e.stopPropagation(),h.style.display="none",document.getElementById("inputPassword").value=""})),E.addEventListener("click",(e=>{e.stopPropagation(),x.style.display="none",document.getElementById("name").value="",document.getElementById("wish").value="",document.getElementById("password").value=""})),S.addEventListener("click",(e=>{e.stopPropagation(),C.style.display="none",document.getElementById("inputPassword").value=""})),H.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation();const n=document.getElementById("name").value.trim(),o=document.getElementById("wish").value.trim(),i=document.getElementById("password").value.trim();if(n&&o&&i){if(!/^\d+$/.test(i))return;if(c.some((e=>e.userData.name===n)))return;z(n,o,i,e,c,l,!0,null)&&(x.style.display="none",document.getElementById("name").value="",document.getElementById("wish").value="",document.getElementById("password").value="")}})),x.addEventListener("click",(function(e){e.stopPropagation(),document.getElementById("inputPassword").value=""})),T.addEventListener("click",(function(e){e.stopPropagation()})),b.addEventListener("click",(function(e){e.stopPropagation(),j()})),P.addEventListener("click",(function(e){e.stopPropagation(),J()})),w.addEventListener("click",(async function(e){e.stopPropagation();const t=document.getElementById("inputPassword").value.trim(),n=m.userData.pageId,o=document.getElementById("inputPassword"),i=document.querySelector(".password-error-message");i&&i.remove();try{const e=await fetch(`${L}/functions/v1/moon/verifyPassword`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRsb2p0aXBpaWphYnRuYWtla3dwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjYzNTU1OTEsImV4cCI6MjA0MTkzMTU5MX0.Oy4oW0oCnSSV2aIFPJ-NO8cLQjtrqEcrwu1F2nJj-TU"},body:JSON.stringify({enteredPassword:t,pageId:n})});if(e.ok){"비밀번호가 일치합니다."===(await e.json()).message?(f.textContent=m.userData.name,g.textContent=m.userData.wish,h.style.display="block",y.style.display="none"):O(o,"비밀번호가 잘못되었습니다.")}else O(o,"비밀번호가 잘못되었습니다.")}catch(a){O(o,"서버 오류가 발생했습니다. 나중에 다시 시도해주세요.")}})),y.addEventListener("click",(function(e){e.stopPropagation()})),b.addEventListener("click",j),P.addEventListener("click",J),v.addEventListener("click",(e=>{m&&(M.value=m.userData.name,B.value=m.userData.wish,R.value="",f.style.display="none",g.style.display="none",v.style.display="none",I.style.display="none",T.style.display="flex",h.style.display="block"),h.style.display="block",e.stopPropagation()}));document.getElementById("deletePlanetBtn").addEventListener("click",(t=>{if(m){if(confirm("정말 이 행성을 삭제하시겠습니까?")){const t=m.userData.pageId;t&&async function(e){try{const t=await fetch(`${L}/functions/v1/moon/deleteNotion/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRsb2p0aXBpaWphYnRuYWtla3dwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjYzNTU1OTEsImV4cCI6MjA0MTkzMTU5MX0.Oy4oW0oCnSSV2aIFPJ-NO8cLQjtrqEcrwu1F2nJj-TU"}});if(t.ok);else{await t.text()}}catch(t){}}(t).then((()=>{e.remove(m),c=c.filter((e=>e!==m)),m=null,x.style.display="none",h.style.display="none"})).catch((e=>{}))}}t.stopPropagation()}));const N=1;async function z(e,t,n,o,i,a,s=!0,r=null){const l={name:e,wish:t,password:null,pageId:null,isInteractable:!1};if(s&&!r)try{const o=await async function(e,t,n){const o={name:e,wish:t,password:n};try{const e=await fetch(`${L}/functions/v1/moon/saveToNotion`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRsb2p0aXBpaWphYnRuYWtla3dwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjYzNTU1OTEsImV4cCI6MjA0MTkzMTU5MX0.Oy4oW0oCnSSV2aIFPJ-NO8cLQjtrqEcrwu1F2nJj-TU"},body:JSON.stringify(o)});return e.ok?await e.json():(await e.text(),null)}catch(i){return null}}(e,t,n);if(!o)return null;l.pageId=o.pageId,l.password=o.hashedPassword,l.isInteractable=!0}catch(h){return null}else r&&(l.pageId=r,l.isInteractable=!0);const c=new THREE.SphereGeometry(10,10,10);c.scale(.04,.04,.04);const d=new THREE.MeshStandardMaterial({color:16777215,emissive:16777215,emissiveIntensity:3,roughness:.4,metalness:.4}),u=new THREE.Mesh(c,d);u.userData=l;let m,p=.1;do{const e=2*Math.random()-1,t=2*Math.random()-1,n=2*Math.random()-1,o=new THREE.Vector3(e,t,n).normalize(),a=4+16*Math.random();m=o.multiplyScalar(a),m.y<2&&(m.y=2),u.updateMatrixWorld(!0);const s=(new THREE.Box3).setFromObject(u);let r=!1;for(let l of i){if(u.position.distanceTo(l.position)<10){r=!0;break}if((new THREE.Box3).setFromObject(l).intersectsBox(s)){r=!0;break}}if(!r)break;p++}while(p<10);10===p&&(m=new THREE.Vector3(4,2,0)),u.position.copy(m);const y=new THREE.SphereGeometry(10,10,10);y.scale(.04,.04,.04);const E=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.2,blending:THREE.AdditiveBlending}),w=new THREE.Mesh(y,E);if(u.add(w),a){const t=W(e);t.position.set(0,.8,0),u.add(t),u.userData.textSprite=t}return o.add(u),i.push(u),u}function W(e){const t=document.createElement("canvas"),n=t.getContext("2d"),o=100;n.font="100px 'Noto Sans KR', sans-serif";const i=n.measureText(e).width;t.width=i,t.height=150,n.font="100px 'Noto Sans KR', sans-serif",n.fillStyle="white",n.fillText(e,0,o);const a=new THREE.CanvasTexture(t),s=new THREE.SpriteMaterial({map:a,transparent:!0}),r=new THREE.Sprite(s);return r.scale.set(.003*t.width,.003*t.height,1),r}let F=null;function A(o){const i=n.domElement.getBoundingClientRect();r.x=(o.clientX-i.left)/i.width*2-1,r.y=-(o.clientY-i.top)/i.height*2+1,s.setFromCamera(r,t);const a=e.children.filter((e=>e.userData.isInteractable)),l=s.intersectObjects(a,!0);if(l.length>0){const t=l[0].object;document.body.style.cursor="pointer",c=t,F&&e.remove(F),F=new THREE.BoxHelper(c,16776960),e.add(F)}else document.body.style.cursor="default",F&&(e.remove(F),F=null);var c}const X="\nuniform float uTime;\n\nvarying vec3 vPosition;\nvarying vec2 vUv;\nvarying vec3 vNormal;\n\nfloat wave(float waveSize, float tipDistance, float centerDistance) {\n    bool isTip = (gl_VertexID + 1) % 5 == 0;\n    float waveDistance = isTip ? tipDistance : centerDistance;\n    return sin((uTime / 1000.0) + waveSize) * waveDistance;\n}\n\nvoid main() {\n    vPosition = position;\n    vUv = uv;\n    vNormal = normalize(normalMatrix * normal);\n\n    if (vPosition.y < 0.0) {\n        vPosition.y = 0.0;\n    } else {\n        vPosition.x += wave(uv.x * 10.0, 0.3, 0.1);      \n    }\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(vPosition, 1.0);\n}\n",Y="\nuniform sampler2D uCloud;\n\nvarying vec3 vPosition;\nvarying vec2 vUv;\nvarying vec3 vNormal;\n\nvec3 grassColor = vec3(1, 0.6, 0.2);\n\nvoid main() {\n    vec3 color = mix(grassColor * 0.5, grassColor, vPosition.y);\n    color = mix(color, texture2D(uCloud, vUv).rgb, 0.4);\n    float lighting = normalize(dot(vNormal, vec3(10)));\n    gl_FragColor = vec4(color + lighting * 0.03, 1.0);\n}\n";function U(e,t=0){const n=1+.6*Math.random(),o=5*t,i=Math.random()*Math.PI*2,a=[Math.sin(i),0,-Math.cos(i)],s=Math.random()*Math.PI*2,r=[Math.sin(s),0,-Math.cos(s)],l=a.map(((t,n)=>.05*t*1+e[n])),c=a.map(((t,n)=>.05*t*-1+e[n])),d=a.map(((t,n)=>.025*t*1+e[n])),u=a.map(((t,n)=>.025*t*-1+e[n])),m=r.map(((t,n)=>.1*t+e[n]));return d[1]+=n/2,u[1]+=n/2,m[1]+=n,{positions:[...l,...c,...u,...d,...m],indices:[o,o+1,o+2,o+2,o+4,o+3,o+3,o,o+2]}}function V(e,t,n,o,i){return(e-t)*(i-o)/(n-t)+o}function _(e){if(requestAnimationFrame((()=>_(e))),e.material.uniforms.uTime.value=performance.now(),t.position.y<N&&(t.position.y=N),o.update(),i.render(),"grid"===y.style.display&&m){const e=function(e){const n=new THREE.Vector3;return e.updateMatrixWorld(),n.setFromMatrixPosition(e.matrixWorld),n.project(t),{x:(.5*n.x+.5)*window.innerWidth,y:(.5*-n.y+.5)*window.innerHeight}}(m);y.style.left=`${e.x}px`,y.style.top=`${e.y+20}px`}}window.addEventListener("resize",(()=>{n.setSize(window.innerWidth,window.innerHeight),i.setSize(window.innerWidth,window.innerHeight),t.aspect=window.innerWidth/window.innerHeight,t.updateProjectionMatrix()})),k.addEventListener("click",(()=>{t.position.copy(d),o.target.copy(u),o.update()})),function(){(new THREE.TextureLoader).load("./assets/autumn.jpg",(function(t){e.background=t})),e=new THREE.Scene,t=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3),t.position.set(2,0,.8),d.copy(t.position),n=new THREE.WebGLRenderer({antialias:!0}),n.setSize(window.innerWidth,window.innerHeight),D.appendChild(n.domElement);const c=new THREE.AmbientLight(16777215);e.add(c);const m=new THREE.PointLight(16777215,.5);m.position.set(10,10,10),e.add(m),o=new THREE.OrbitControls(t,n.domElement),o.enableDamping=!0,o.dampingFactor=.05,o.minPolarAngle=Math.PI/2.5,o.maxPolarAngle=2*Math.PI/5,o.minDistance=20,o.maxDistance=50,u.copy(o.target),s=new THREE.Raycaster,r=new THREE.Vector2,window.addEventListener("mousemove",A,!1),(new THREE.FontLoader).load("https://threejs.org/examples/fonts/helvetiker_regular.typeface.json",(function(e){l=e}),void 0,(function(e){}));const p=new THREE.RenderPass(e,t);a=new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),1.5,.7,.8),i=new THREE.EffectComposer(n),i.addPass(p),i.addPass(a);const y=function(e,t){const n=function(e,t){const n=[],o=[],i=[];for(let s=0;s<t;s++){const t=e/2*-1,a=e/2,r=e/2*Math.random(),l=2*Math.random()*Math.PI,c=r*Math.cos(l),d=r*Math.sin(l);o.push(...Array.from({length:6}).flatMap((()=>[V(c,t,a,0,1),V(d,t,a,0,1)])));const u=U([c,0,d],s);n.push(...u.positions),i.push(...u.indices)}const a=new THREE.BufferGeometry;return a.setAttribute("position",new THREE.BufferAttribute(new Float32Array(n),3)),a.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(o),2)),a.setIndex(i),a.computeVertexNormals(),a}(e,t),o=(new THREE.TextureLoader).load("./assets/cloud.jpg");o.wrapS=o.wrapT=THREE.RepeatWrapping;const i=new THREE.ShaderMaterial({uniforms:{uCloud:{value:o},uTime:{value:0}},side:THREE.DoubleSide,vertexShader:X,fragmentShader:Y}),a=new THREE.Mesh(n,i),s=new THREE.Mesh(new THREE.CircleGeometry(20,50).rotateX(Math.PI/2),i);return s.position.y=-Number.EPSILON,a.add(s),a}(30,5e4);e.add(y),function(){const t=new THREE.GLTFLoader,n=new THREE.DRACOLoader;n.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),t.setDRACOLoader(n),t.load("./assets/tree.glb",(function(t){const n=t.scene;n.scale.set(5,5,5),n.position.set(6,.5,5),n.rotation.set(0,0,0),n.userData.isTree=!0,n.userData.isInteractable=!0,e.add(n)}),void 0,(function(e){})),t.load("./assets/moon.glb",(function(t){const n=t.scene;n.scale.set(5,5,5),n.position.set(-2,1,0),n.rotation.set(2.5,65,0),e.add(n)}),void 0,(function(e){})),t.load("./assets/house.glb",(function(t){const n=t.scene;n.scale.set(8,8,8),n.position.set(6,.5,0),n.userData.isClickable=!0,n.traverse((function(e){e.isMesh&&(e.userData.isClickable=!0)})),e.add(n)}),void 0,(function(e){}))}(),_(y)}()}));
