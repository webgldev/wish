let e,t,n,o,a,i;!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();let s,r,l,d=[],c=new THREE.Vector3,u=new THREE.Vector3,m=null,p=null;document.addEventListener("DOMContentLoaded",(function(){const y=document.getElementById("passwordInput"),E=document.getElementById("closePlanetForm"),w=document.getElementById("submitPassword"),h=document.getElementById("wishModal"),f=document.getElementById("closeWishModal"),v=document.getElementById("wishName"),g=document.getElementById("wishText"),T=document.getElementById("modifyWishBtn"),x=document.getElementById("editWishDiv"),I=document.getElementById("editNameInput"),P=document.getElementById("editWishInput"),B=document.getElementById("editPasswordInput"),D=document.getElementById("saveWishBtn"),R=document.getElementById("cancelWishBtn"),H=document.getElementById("planetFormModal"),b=document.getElementById("passwordInput"),M=document.getElementById("closePasswordInputModal"),k=document.getElementById("resetView"),C=document.getElementById("container"),L=document.getElementById("createPlanetBtn"),S="https://tlojtipiijabtnakekwp.supabase.co";function N(e,t){const n=document.createElement("span");n.className="password-error-message",n.style.color="red",n.style.fontSize="0.9em",n.style.marginTop="5px",n.textContent=t,e.parentNode.insertBefore(n,e.nextSibling)}async function A(){if(!p)return;const e=I.value.trim(),t=P.value.trim(),n=B.value.trim();if(""===e||""===t||""===n)return void alert("모든 필드를 입력해주세요.");if(!/^\d+$/.test(n))return void alert("비밀번호는 숫자만 입력해주세요.");if(d.some((t=>t.userData.name===e&&t!==m)))alert("이미 존재하는 이름입니다. 다른 이름을 선택해주세요.");else if(p.userData.name=e,p.userData.wish=t,p.userData.pageId)try{if(await async function(e,t,n){const o={Name:{title:[{text:{content:t}}]},Wish:{rich_text:[{text:{content:n}}]}};try{const t=await fetch(`${S}/functions/v1/moon/updateNotion/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:"..."},body:JSON.stringify({properties:o})});if(t.ok);else{await t.text()}}catch(a){}}(p.userData.pageId,e,t),v.textContent=e,g.textContent=t,p.userData.textSprite){p.remove(p.userData.textSprite);const t=_(e);t.position.set(0,.8,0),p.add(t),p.userData.textSprite=t}j()}catch(o){}}function j(){v.style.display="block",g.style.display="block",T.style.display="inline",f.style.display="inline",x.style.display="none"}f.addEventListener("click",(e=>{e.stopPropagation(),h.style.display="none"})),E.addEventListener("click",(e=>{e.stopPropagation(),H.style.display="none"})),M.addEventListener("click",(e=>{e.stopPropagation(),b.style.display="none"})),L.addEventListener("click",(t=>{t.stopPropagation();const n=document.getElementById("name").value.trim(),o=document.getElementById("wish").value.trim(),a=document.getElementById("password").value.trim();if(n&&o&&a){if(!/^\d+$/.test(a))return void alert("비밀번호는 숫자만 입력해주세요.");if(d.some((e=>e.userData.name===n)))return void alert("이미 존재하는 이름입니다. 다른 이름을 선택해주세요.");const t=z(n,o,a,e,d,l,!1,null);W(n,o,a).then((e=>{e&&(t.userData.pageId=e.pageId,t.userData.password=e.hashedPassword)})).catch((e=>{})),H.style.display="none",document.getElementById("name").value="",document.getElementById("wish").value="",document.getElementById("password").value=""}else alert("모든 필드를 입력해주세요.")})),x.addEventListener("click",(function(e){e.stopPropagation()})),D.addEventListener("click",(function(e){e.stopPropagation(),A()})),R.addEventListener("click",(function(e){e.stopPropagation(),j()})),w.addEventListener("click",(async function(e){e.stopPropagation();const t=document.getElementById("inputPassword").value.trim(),n=m.userData.pageId,o=document.getElementById("inputPassword"),a=document.querySelector(".password-error-message");a&&a.remove();try{const e=await fetch(`${S}/functions/v1/moon/verifyPassword`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"..."},body:JSON.stringify({enteredPassword:t,pageId:n})});if(e.ok){"비밀번호가 일치합니다."===(await e.json()).message?(v.textContent=m.userData.name,g.textContent=m.userData.wish,h.style.display="block",y.style.display="none"):N(o,"비밀번호가 잘못되었습니다.")}else N(o,"비밀번호가 잘못되었습니다.")}catch(i){N(o,"서버 오류가 발생했습니다. 나중에 다시 시도해주세요.")}})),y.addEventListener("click",(function(e){e.stopPropagation()})),D.addEventListener("click",A),R.addEventListener("click",j),T.addEventListener("click",(e=>{m&&(I.value=m.userData.name,P.value=m.userData.wish,B.value="",v.style.display="none",g.style.display="none",T.style.display="none",f.style.display="none",x.style.display="flex",h.style.display="block"),h.style.display="block",e.stopPropagation()}));async function W(e,t,n){const o={name:e,wish:t,password:n};try{const e=await fetch(`${S}/functions/v1/moon/saveToNotion`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"..."},body:JSON.stringify(o)});if(e.ok){return await e.json()}await e.text();return null}catch(a){return null}}document.getElementById("deletePlanetBtn").addEventListener("click",(e=>{if(m){if(confirm("정말 이 행성을 삭제하시겠습니까?")){const e=m.userData.pageId;e?(!async function(e){try{const t=await fetch(`${S}/functions/v1/moon/deleteNotion/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:"..."}});if(t.ok);else{await t.text()}}catch(t){}}(e),deletePlanet(m),H.style.display="none",h.style.display="none"):alert("데이터 ID가 없습니다.")}}else alert("삭제할 행성이 선택되지 않았습니다.");e.stopPropagation()})),window.addEventListener("load",(async()=>{try{const e=await fetch(`${S}/functions/v1/moon/visit`,{method:"GET",headers:{Authorization:"..."}}),t=await e.json();document.getElementById("visitorCount").textContent=`${t.count}`}catch(t){}!async function(n){try{const t=await fetch(`${S}/functions/v1/moon/getNotionData`,{method:"GET",headers:{Authorization:"..."}});if(t.ok){(await t.json()).forEach((t=>{var o,a,i,s,r,c;const u=null==(o=t.properties.Name)?void 0:o.title,m=null==(a=t.properties.Wish)?void 0:a.rich_text,p=u&&(null==(s=null==(i=u[0])?void 0:i.text)?void 0:s.content)||"Unknown",y=m&&(null==(c=null==(r=m[0])?void 0:r.text)?void 0:c.content)||"No wish",E=t.id;n(p,y,null,e,d,l,!1,E)}))}}catch(t){}}(z)}));const O=1;async function z(e,t,n,o,a,i,s=!0,r=null){const l=new THREE.SphereGeometry(10,10,10);l.scale(.04,.04,.04);const d=new THREE.MeshStandardMaterial({color:16777215,emissive:16777215,emissiveIntensity:3,roughness:.4,metalness:.4}),c=new THREE.Mesh(l,d);let u,m=.1;do{const e=2*Math.random()-1,t=2*Math.random()-1,n=2*Math.random()-1,o=new THREE.Vector3(e,t,n).normalize(),i=4+16*Math.random();u=o.multiplyScalar(i),u.y<2&&(u.y=2),c.updateMatrixWorld(!0);const s=(new THREE.Box3).setFromObject(c);let r=!1;for(let l of a){if(c.position.distanceTo(l.position)<10){r=!0;break}if((new THREE.Box3).setFromObject(l).intersectsBox(s)){r=!0;break}}if(!r)break;m++}while(m<10);10===m&&(u=new THREE.Vector3(4,2,0)),c.position.copy(u),c.userData={name:e,wish:t,password:n,pageId:r,isInteractable:!0},a.push(c);const p=new THREE.SphereGeometry(10,10,10);p.scale(.04,.04,.04);const y=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.2,blending:THREE.AdditiveBlending}),E=new THREE.Mesh(p,y);if(c.add(E),i){const t=_(e);t.position.set(0,.8,0),c.add(t),c.userData.textSprite=t}if(s&&!r){const o=await W(e,t,n);if(o){const e=o.pageId,t=o.hashedPassword;c.userData.pageId=e,c.userData.password=t}}o.add(c)}function _(e){const t=document.createElement("canvas"),n=t.getContext("2d"),o=100;n.font="100px 'Noto Sans KR', sans-serif";const a=n.measureText(e).width;t.width=a,t.height=150,n.font="100px 'Noto Sans KR', sans-serif",n.fillStyle="white",n.fillText(e,0,o);const i=new THREE.CanvasTexture(t),s=new THREE.SpriteMaterial({map:i,transparent:!0}),r=new THREE.Sprite(s);return r.scale.set(.003*t.width,.003*t.height,1),r}window.addEventListener("click",(function(o){o.preventDefault();const a=n.domElement.getBoundingClientRect();r.x=(o.clientX-a.left)/a.width*2-1,r.y=-(o.clientY-a.top)/a.height*2+1,s.setFromCamera(r,t);const i=e.children.filter((e=>e.userData.isInteractable)),l=s.intersectObjects(i,!0);let d=l[0].object;if(l.length>0){if("Blackwalnut_Autumn01_Blackwalnut_Autumn01_Mat_0"===d.userData.name||"Blackwalnut_Autumn01_Blackwalnut_Bark_Mat_0"===d.userData.name)return void(H.style.display="grid");for(;d;){if(d.userData.name){m=d,p=m;const e=document.getElementById("planetName");return e&&m.userData.name&&(e.textContent=`행성 이름: ${m.userData.name}`),void(y.style.display="grid")}d=d.parent}m=null,y.style.display="none",H.style.display="none"}else m=null,y.style.display="none",H.style.display="none"}),!1);let F=null;function $(o){const a=n.domElement.getBoundingClientRect();r.x=(o.clientX-a.left)/a.width*2-1,r.y=-(o.clientY-a.top)/a.height*2+1,s.setFromCamera(r,t);const i=e.children.filter((e=>e.userData.isInteractable)),l=s.intersectObjects(i,!0);if(l.length>0){const t=l[0].object;document.body.style.cursor="pointer",d=t,F&&e.remove(F),F=new THREE.BoxHelper(d,16776960),e.add(F)}else document.body.style.cursor="default",F&&(e.remove(F),F=null);var d}const V="\nuniform float uTime;\n\nvarying vec3 vPosition;\nvarying vec2 vUv;\nvarying vec3 vNormal;\n\nfloat wave(float waveSize, float tipDistance, float centerDistance) {\n    bool isTip = (gl_VertexID + 1) % 5 == 0;\n    float waveDistance = isTip ? tipDistance : centerDistance;\n    return sin((uTime / 1000.0) + waveSize) * waveDistance;\n}\n\nvoid main() {\n    vPosition = position;\n    vUv = uv;\n    vNormal = normalize(normalMatrix * normal);\n\n    if (vPosition.y < 0.0) {\n        vPosition.y = 0.0;\n    } else {\n        vPosition.x += wave(uv.x * 10.0, 0.3, 0.1);      \n    }\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(vPosition, 1.0);\n}\n",G="\nuniform sampler2D uCloud;\n\nvarying vec3 vPosition;\nvarying vec2 vUv;\nvarying vec3 vNormal;\n\nvec3 grassColor = vec3(1, 0.6, 0.2);\n\nvoid main() {\n    vec3 color = mix(grassColor * 0.5, grassColor, vPosition.y);\n    color = mix(color, texture2D(uCloud, vUv).rgb, 0.4);\n    float lighting = normalize(dot(vNormal, vec3(10)));\n    gl_FragColor = vec4(color + lighting * 0.03, 1.0);\n}\n";function U(e,t=0){const n=1+.6*Math.random(),o=5*t,a=Math.random()*Math.PI*2,i=[Math.sin(a),0,-Math.cos(a)],s=Math.random()*Math.PI*2,r=[Math.sin(s),0,-Math.cos(s)],l=i.map(((t,n)=>.05*t*1+e[n])),d=i.map(((t,n)=>.05*t*-1+e[n])),c=i.map(((t,n)=>.025*t*1+e[n])),u=i.map(((t,n)=>.025*t*-1+e[n])),m=r.map(((t,n)=>.1*t+e[n]));return c[1]+=n/2,u[1]+=n/2,m[1]+=n,{positions:[...l,...d,...u,...c,...m],indices:[o,o+1,o+2,o+2,o+4,o+3,o+3,o,o+2]}}function q(e,t,n,o,a){return(e-t)*(a-o)/(n-t)+o}function J(e){if(requestAnimationFrame((()=>J(e))),e.material.uniforms.uTime.value=performance.now(),t.position.y<O&&(t.position.y=O),o.update(),a.render(),"grid"===y.style.display&&m){const e=function(e){const n=new THREE.Vector3;return e.updateMatrixWorld(),n.setFromMatrixPosition(e.matrixWorld),n.project(t),{x:(.5*n.x+.5)*window.innerWidth,y:(.5*-n.y+.5)*window.innerHeight}}(m);y.style.left=`${e.x}px`,y.style.top=`${e.y+20}px`}}window.addEventListener("resize",(()=>{n.setSize(window.innerWidth,window.innerHeight),a.setSize(window.innerWidth,window.innerHeight),t.aspect=window.innerWidth/window.innerHeight,t.updateProjectionMatrix()})),k.addEventListener("click",(()=>{t.position.copy(c),o.target.copy(u),o.update()})),function(){(new THREE.TextureLoader).load("./assets/autumn.jpg",(function(t){e.background=t})),e=new THREE.Scene,t=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3),t.position.set(2,0,.8),c.copy(t.position),n=new THREE.WebGLRenderer({antialias:!0}),n.setSize(window.innerWidth,window.innerHeight),C.appendChild(n.domElement);const d=new THREE.AmbientLight(16777215);e.add(d);const m=new THREE.PointLight(16777215,.5);m.position.set(10,10,10),e.add(m),o=new THREE.OrbitControls(t,n.domElement),o.enableDamping=!0,o.dampingFactor=.05,o.minPolarAngle=Math.PI/2.5,o.maxPolarAngle=2*Math.PI/5,o.minDistance=20,o.maxDistance=50,u.copy(o.target),s=new THREE.Raycaster,r=new THREE.Vector2,window.addEventListener("mousemove",$,!1),(new THREE.FontLoader).load("https://threejs.org/examples/fonts/helvetiker_regular.typeface.json",(function(e){l=e}),void 0,(function(e){}));const p=new THREE.RenderPass(e,t);i=new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),1.5,.7,.8),a=new THREE.EffectComposer(n),a.addPass(p),a.addPass(i);const y=function(e,t){const n=function(e,t){const n=[],o=[],a=[];for(let s=0;s<t;s++){const t=e/2*-1,i=e/2,r=e/2*Math.random(),l=2*Math.random()*Math.PI,d=r*Math.cos(l),c=r*Math.sin(l);o.push(...Array.from({length:6}).flatMap((()=>[q(d,t,i,0,1),q(c,t,i,0,1)])));const u=U([d,0,c],s);n.push(...u.positions),a.push(...u.indices)}const i=new THREE.BufferGeometry;return i.setAttribute("position",new THREE.BufferAttribute(new Float32Array(n),3)),i.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(o),2)),i.setIndex(a),i.computeVertexNormals(),i}(e,t),o=(new THREE.TextureLoader).load("./assets/cloud.jpg");o.wrapS=o.wrapT=THREE.RepeatWrapping;const a=new THREE.ShaderMaterial({uniforms:{uCloud:{value:o},uTime:{value:0}},side:THREE.DoubleSide,vertexShader:V,fragmentShader:G}),i=new THREE.Mesh(n,a),s=new THREE.Mesh(new THREE.CircleGeometry(20,50).rotateX(Math.PI/2),a);return s.position.y=-Number.EPSILON,i.add(s),i}(30,5e4);e.add(y),function(){const t=new THREE.GLTFLoader,n=new THREE.DRACOLoader;n.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),t.setDRACOLoader(n),t.load("./assets/tree.glb",(function(t){const n=t.scene;n.scale.set(5,5,5),n.position.set(6,.5,5),n.rotation.set(0,0,0),n.userData.isTree=!0,n.userData.isInteractable=!0,e.add(n)}),void 0,(function(e){})),t.load("./assets/moon.glb",(function(t){const n=t.scene;n.scale.set(5,5,5),n.position.set(-2,1,0),n.rotation.set(2.5,65,0),e.add(n)}),void 0,(function(e){})),t.load("./assets/house.glb",(function(t){const n=t.scene;n.scale.set(8,8,8),n.position.set(6,.5,0),n.userData.isClickable=!0,n.traverse((function(e){e.isMesh&&(e.userData.isClickable=!0)})),e.add(n)}),void 0,(function(e){}))}(),J(y)}()}));
